<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>美食家さん</title>
  <link rel="stylesheet" href="style_pc.css" />
</head>
<body onload="checkLogin(); loadUserSettings(); loadCalorieInfo();">
  <div class="home-page">
    <div class="header-row">
      <div class="profile-section">
        <img id="profileIcon" src="img/user-icon.png" alt="ユーザーアイコン" class="profile-icon">
        <div class="user-name" id="userName">こんにちは、美食家さん！</div>
      </div>

      <div class="header-buttons">
        <!-- ✨ 追加：人生のフルコース（黄金＆きらっと演出） -->
        <button class="life-course-button" onclick="goLifeCourse(event)">✨ 人生のフルコース</button>

        <button class="settings-button" onclick="window.location.href='settings.html'">⚙️ 設定</button>
        <button class="logout-button" onclick="logout()">ログアウト</button>
      </div>
    </div>

    <div class="calorie-card">
      <div class="rank-label">本日の摂取カロリー</div>
      <div class="calorie-value"><span id="currentCalorie">0</span> kcal</div>
      <div class="rank-sub">目標まであと <span id="remainingCalorie">--</span> kcal</div>
    </div>

    <div class="feature-grid">
      <div class="feature-card" onclick="switchPage('meal')">📷<br>食事記録</div>
      <div class="feature-card" onclick="switchPage('insights')">📊<br>栄養チェック</div>
      <div class="feature-card" onclick="switchPage('characters')">👻<br>キャラ育成</div>
      <div class="feature-card" onclick="switchPage('nutrients')">👥<br>栄養分析</div>
      <div class="feature-card" onclick="switchPage('akinator')">🍽️<br>AI献立</div>
      <div class="feature-card" onclick="switchPage('shop')">🛒<br>ショップ</div>
    </div>
  </div>

  <script>
    // ========= 共通 =========
    function checkLogin() {
      if (localStorage.getItem("loggedIn") !== "true") {
        window.location.href = "login.html";
      }
    }
    function logout() {
      localStorage.removeItem("loggedIn");
      window.location.href = "login.html";
    }
    function switchPage(pageName) {
      window.location.href = `pages/${pageName}/index.html`;
    }
    function loadUserSettings() {
      const userName = localStorage.getItem("username") || "美食家さん";
      document.getElementById("userName").textContent = `こんにちは、${userName}！`;
      const userIcon = localStorage.getItem("userIcon");
      if (userIcon) document.getElementById("profileIcon").src = userIcon;
    }

    // mealページは date を ISO 文字列(UTC)で保存しているので、それに合わせて判定
    function isoToday() {
      return new Date().toISOString().slice(0, 10); // YYYY-MM-DD
    }

    // ========= 本日のカロリー合計（mealの合計だけを集計） =========
    function loadCalorieInfo() {
      const calorieGoal = parseInt(localStorage.getItem("calorieGoal")) || 1580;
      const todayKey = isoToday();

      let totalKcal = 0;
      try {
        const meals = JSON.parse(localStorage.getItem("bisyokuka_meals_v2") || "[]");
        totalKcal = meals
          .filter(m => (m.date || "").slice(0, 10) === todayKey)
          .reduce((sum, m) => sum + Number(m.totals?.kcal ?? m.kcal ?? 0), 0);
      } catch {
        totalKcal = 0;
      }

      document.getElementById("currentCalorie").textContent = totalKcal;
      document.getElementById("remainingCalorie").textContent = Math.max(0, calorieGoal - totalKcal);
    }

    // 他タブで meal を追加した場合も更新（任意）
    window.addEventListener("storage", (e) => {
      if (e.key === "bisyokuka_meals_v2" || e.key === "calorieGoal") {
        loadCalorieInfo();
      }
      if (e.key === "username" || e.key === "userIcon") {
        loadUserSettings();
      }
    });

    // ========= 追加：人生のフルコースボタンの演出＆遷移 =========
    function goLifeCourse(ev) {
      const btn = ev.currentTarget;
      // クリック演出クラスを付与
      btn.classList.add('kira');
      // アニメーション終了後に遷移（保険でタイムアウトも用意）
      const to = setTimeout(() => {
        window.location.href = 'pages/人生のフルコース/index.html';
      }, 500);
      btn.addEventListener('animationend', () => {
        clearTimeout(to);
        window.location.href = 'pages/人生のフルコース/index.html';
      }, { once: true });
    }
  </script>
</body>
</html>
