<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç¾é£Ÿå®¶ã•ã‚“ å›³é‘‘ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --line:#1f2937;
    --muted:#94a3b8; --brand:#0ea5e9; --accent:#f59e0b; --ok:#22c55e;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:#ffbb54;text-decoration:none}
  .wrap{width:92%;max-width:1080px;margin:18px auto 32px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  h1{margin:0;font-size:22px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .chip, select, input[type="search"]{
    background:#0b1220;border:1px solid var(--line);color:var(--ink);border-radius:999px;padding:8px 12px
  }
  .chip.active{background:var(--brand);color:#031422;font-weight:700;border-color:transparent}
  .btn{background:var(--accent);color:#111;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  .ghost{background:var(--brand);color:#031422}
  /* summary */
  .summary{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin:14px 0}
  @media (max-width:800px){ .summary{grid-template-columns:1fr} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .label{color:var(--muted);font-size:12px}
  .value{font-weight:800;font-size:22px}
  .progress{height:10px;border-radius:999px;background:#0b1220;border:1px solid var(--line);overflow:hidden;margin-top:8px}
  .bar{height:100%;background:linear-gradient(90deg,#22c55e,#0ea5e9)}
  .hint{color:var(--muted);font-size:12px;margin-top:6px}

  /* list */
  .tools{display:grid;grid-template-columns:1fr auto auto;gap:8px}
  @media (max-width:800px){ .tools{grid-template-columns:1fr 1fr} .tools .right{grid-column:1/-1}}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-top:12px}
  .dex{background:#0b1220;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .thumb{width:100%;aspect-ratio:4/3;object-fit:cover;display:block;background:#0e1626}
  .dex .body{padding:10px}
  .name{font-weight:700}
  .meta{color:var(--muted);font-size:12px;margin-top:4px;display:flex;gap:8px;flex-wrap:wrap}
  .badge{display:inline-block;background:#0e1626;border:1px solid var(--line);border-radius:999px;padding:2px 6px;font-size:12px}
  .empty{padding:18px;border:1px dashed var(--line);border-radius:12px;text-align:center;color:var(--muted)}
  .topline{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ğŸ“š å›³é‘‘ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</h1>
    <div class="row">
      <a class="btn ghost" href="../characters/index.html">ğŸ‘¤ ã‚­ãƒ£ãƒ©è‚²æˆã¸</a>
      <a class="btn" href="../../index.html">â† ãƒ›ãƒ¼ãƒ </a>
    </div>
  </header>

  <!-- æœŸé–“ãƒãƒƒãƒ— & ãƒ„ãƒ¼ãƒ« -->
  <div class="row" id="rangeChips">
    <button class="chip" data-range="today">ä»Šæ—¥</button>
    <button class="chip" data-range="week">ä»Šé€±</button>
    <button class="chip" data-range="month">ä»Šæœˆ</button>
    <button class="chip active" data-range="all">ã™ã¹ã¦</button>
  </div>

  <!-- ã‚µãƒãƒªãƒ¼ -->
  <section class="summary" id="summary">
    <div class="card">
      <div class="label">å›³é‘‘ã«ç™»éŒ²ã•ã‚ŒãŸæ–™ç†æ•°</div>
      <div class="value"><span id="uniques">0</span> ç¨®</div>
      <div class="hint">åŒåæ–™ç†ã¯1ç¨®ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ</div>
    </div>
    <div class="card">
      <div class="label">è¨˜éŒ²å›æ•°ï¼ˆæœŸé–“å†…ï¼‰</div>
      <div class="value"><span id="entries">0</span> å›</div>
      <div class="hint">å†™çœŸã‚’ç™»éŒ²ã—ãŸå›æ•°ã®åˆè¨ˆ</div>
    </div>
    <div class="card">
      <div class="topline">
        <div>
          <div class="label">ã‚­ãƒ£ãƒ©è§£æ”¾çŠ¶æ³</div>
          <div class="value"><span id="unlocked">0</span> / <span id="totalChars">32</span></div>
        </div>
      </div>
      <div class="progress"><div id="bar" class="bar" style="width:0%"></div></div>
      <div class="hint" id="nextHint">æ¬¡ã®è§£æ”¾ã¾ã§ â€” ç¨®</div>
    </div>
  </section>

  <!-- ãƒ„ãƒ¼ãƒ« -->
  <section class="tools">
    <input id="search" type="search" placeholder="æ–™ç†åã§æ¤œç´¢ï¼ˆä¾‹ï¼šãƒ©ãƒ¼ãƒ¡ãƒ³ï¼‰">
    <select id="sort">
      <option value="recent">ä¸¦ã³æ›¿ãˆï¼šæœ€è¿‘é£Ÿã¹ãŸé †</option>
      <option value="count">ä¸¦ã³æ›¿ãˆï¼šè¨˜éŒ²å›æ•°ãŒå¤šã„é †</option>
      <option value="name">ä¸¦ã³æ›¿ãˆï¼šåå‰é †</option>
    </select>
    <div class="right"></div>
  </section>

  <!-- å›³é‘‘ -->
  <section id="list" class="grid"></section>

  <div class="empty" id="empty" hidden>ã“ã®æœŸé–“ã«ã¯ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
</div>

<script>
/* ====== è¨­å®šï¼ˆå¿…è¦ãªã‚‰èª¿æ•´ï¼‰====== */
const TOTAL_CHARS = 32;                 // ç·ã‚­ãƒ£ãƒ©æ•°
const UNLOCK_EVERY = 3;                 // â˜… ä½•ç¨®é¡é›†ã‚ãŸã‚‰1ä½“è§£æ”¾ã‹ï¼ˆä¾‹ï¼š3ç¨®ã”ã¨ï¼‰

/* ====== ãƒ‡ãƒ¼ã‚¿å–å¾— ====== */
const MEALS_KEY = "bisyokuka_meals_v2";
const mealsAll = JSON.parse(localStorage.getItem(MEALS_KEY) || "[]");

function parseDateISO(s){ return new Date(s); }
function ymd(d){ return d.toISOString().slice(0,10); }

function rangeFilter(range){
  const now = new Date();
  let from = null;
  if(range === "today"){
    from = new Date(ymd(now)+"T00:00:00");
  }else if(range === "week"){
    from = new Date(now); from.setDate(now.getDate()-6);
    from = new Date(ymd(from)+"T00:00:00");
  }else if(range === "month"){
    from = new Date(now.getFullYear(), now.getMonth(), 1);
  }
  return (m)=>{
    if(!from) return true;
    const t = parseDateISO(m.date || new Date());
    return t >= from;
  };
}

function buildDex(meals){
  // nameã”ã¨ã«é›†è¨ˆ
  const map = new Map();
  for(const m of meals){
    const name = String(m.food||"ä¸æ˜").trim();
    const date = m.date || new Date().toISOString();
    const rec = map.get(name) || {name, count:0, last:date, first:date, photo:m.photo||"", kcal:0};
    rec.count += 1;
    rec.kcal += Number(m.totals?.kcal||0);
    if(date > rec.last) rec.last = date;
    if(date < rec.first) rec.first = date;
    if(!rec.photo && m.photo) rec.photo = m.photo;
    map.set(name, rec);
  }
  return Array.from(map.values());
}

/* ====== ç”»é¢çŠ¶æ…‹ ====== */
const els = {
  chips: document.getElementById("rangeChips"),
  uniques: document.getElementById("uniques"),
  entries: document.getElementById("entries"),
  unlocked: document.getElementById("unlocked"),
  totalChars: document.getElementById("totalChars"),
  nextHint: document.getElementById("nextHint"),
  bar: document.getElementById("bar"),
  list: document.getElementById("list"),
  empty: document.getElementById("empty"),
  search: document.getElementById("search"),
  sort: document.getElementById("sort"),
};

els.totalChars.textContent = TOTAL_CHARS;

let state = { range:"all", q:"", sort:"recent" };

/* ====== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ====== */
function render(){
  // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿
  const meals = mealsAll.filter(rangeFilter(state.range));
  const dex = buildDex(meals);

  // ã‚µãƒãƒªãƒ¼
  els.entries.textContent = meals.length;
  const uniques = dex.length;
  els.uniques.textContent = uniques;

  // ã‚­ãƒ£ãƒ©è§£æ”¾ãƒ­ã‚¸ãƒƒã‚¯
  const unlocked = Math.min(TOTAL_CHARS, Math.floor(uniques / UNLOCK_EVERY));
  const nextNeed = Math.max(0, (unlocked+1)*UNLOCK_EVERY - uniques);
  els.unlocked.textContent = unlocked;
  els.nextHint.textContent = unlocked >= TOTAL_CHARS
    ? "å…¨ã‚­ãƒ£ãƒ©è§£æ”¾æ¸ˆã¿ï¼"
    : `æ¬¡ã®è§£æ”¾ã¾ã§ ${nextNeed} ç¨®`;
  els.bar.style.width = `${(unlocked / TOTAL_CHARS) * 100}%`;

  // é€²æ—ã‚’ä»–ãƒšãƒ¼ã‚¸ç”¨ã«ä¿å­˜
  localStorage.setItem("bisyokuka_unlocked_chars", String(unlocked));
  localStorage.setItem("bisyokuka_unlock_rule", JSON.stringify({TOTAL_CHARS, UNLOCK_EVERY}));

  // æ¤œç´¢
  const q = state.q.trim();
  const qnorm = q && q.toLowerCase();
  let rows = dex.filter(r => !qnorm || r.name.toLowerCase().includes(qnorm));

  // ã‚½ãƒ¼ãƒˆ
  if(state.sort === "count"){
    rows.sort((a,b)=> b.count - a.count || b.last.localeCompare(a.last));
  }else if(state.sort === "name"){
    rows.sort((a,b)=> a.name.localeCompare(b.name,"ja"));
  }else{ // recent
    rows.sort((a,b)=> b.last.localeCompare(a.last));
  }

  // æç”»
  els.list.innerHTML = "";
  if(rows.length === 0){
    els.empty.hidden = false;
    return;
  }
  els.empty.hidden = true;

  for(const r of rows){
    const div = document.createElement("div");
    div.className = "dex";
    div.innerHTML = `
      <img class="thumb" src="${r.photo || ''}" alt="${r.name}" onerror="this.style.display='none'">
      <div class="body">
        <div class="name">${r.name}</div>
        <div class="meta">
          <span class="badge">å›æ•° ${r.count}</span>
          <span class="badge">æœ€çµ‚ ${new Date(r.last).toLocaleDateString('ja-JP')}</span>
          <span class="badge">åˆè¨ˆ ${Math.round(r.kcal)} kcal</span>
        </div>
      </div>`;
    els.list.appendChild(div);
  }
}

/* ====== ã‚¤ãƒ™ãƒ³ãƒˆ ====== */
els.chips.addEventListener("click", (e)=>{
  const b = e.target.closest(".chip");
  if(!b) return;
  state.range = b.dataset.range;
  // activeåˆ‡æ›¿
  for(const x of els.chips.querySelectorAll(".chip")) x.classList.toggle("active", x===b);
  render();
});
els.search.addEventListener("input", (e)=>{ state.q = e.target.value; render(); });
els.sort.addEventListener("change", (e)=>{ state.sort = e.target.value; render(); });

/* åˆæœŸæç”» */
render();
</script>
</body>
</html>
