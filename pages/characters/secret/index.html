<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>シークレット挑戦（Rhythm Bento）</title>
<style>
  :root{
    --bg:#0b1220;--ink:#e5e7eb;--card:#111827;--line:#243042;
    --accent:#22c55e;--lane:#0c1a2b;--warn:#ef4444;--muted:#9ca3af
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:880px;margin:24px auto;padding:16px}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
  .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .btn{
    background:var(--accent);color:#06210f;border:none;border-radius:10px;
    padding:10px 14px;font-weight:800;cursor:pointer
  }
  .btn.ghost{background:#0ea5e9;color:#031423}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .pill{background:#0b1626;border:1px solid #1a2740;border-radius:999px;padding:6px 10px;font-weight:700}
  .muted{color:var(--muted);text-decoration:none}
  canvas{
    display:block;width:100%;height:430px;
    background:linear-gradient(#0f2238,#0b1626);
    border-radius:12px;border:1px solid #1a2740;margin-top:10px
  }
  @media (max-width:600px){ canvas{height:360px} }
</style>
</head>
<body>
<div class="wrap">
  <h1>シークレット挑戦（Rhythm Bento）</h1>
  <div class="panel">
    <div class="row">
      <div class="row" style="gap:14px">
        <span class="pill">通常：スコアで #33〜#64 解放</span>
        <span class="pill">挑戦：目標達成で #65 解放</span>
      </div>
      <div class="row" style="gap:10px">
        <button class="btn" id="startNormal">START（通常）</button>
        <button class="btn ghost" id="startChallenge">CHALLENGE</button>
        <a class="muted" href="../dex/index.html">← 図鑑へ戻る</a>
      </div>
    </div>

    <div class="row" style="margin-top:6px">
      <div>スコア：<b id="score">0</b>　ベスト：<b id="best">0</b>（通常）</div>
      <div id="goalText" class="muted">CHALLENGE目標：スコア 820 以上で #65 解放</div>
    </div>

    <canvas id="cv"></canvas>

    <div class="muted" style="margin-top:6px">
      操作: A / S / K / L（スマホはレーンをタップ）／ Spaceで一時停止／
      途中でタブを離れると自動一時停止
    </div>
  </div>
</div>

<script>
/* ===== ストレージ規約 =====
   - 通常モード終了時：rawScore(0..1000) を 3倍して arcade_best に反映（#33〜#64の解放用）
   - ゲーム固有のベスト：rhythm_best に保存
   - CHALLENGE達成で #65 を解放（dex_state_v1 に直接書き込み）
*/
const ARCADE_KEY   = 'arcade_best';
const RHYTHM_KEY   = 'rhythm_best';
const DEX_KEY      = 'dex_state_v1';
const SECRET65_ID  = 64;              // #65（0始まり）
const SECRET_FILE  = 'secret_65.png'; // 画像は project-root に配置してね
const SECRET_TARGET= 820;             // ← ここを変えれば目標スコア変更

function loadDex(){ try{ return JSON.parse(localStorage.getItem(DEX_KEY)||'{}'); }catch{ return {}; } }
function saveDex(v){ localStorage.setItem(DEX_KEY, JSON.stringify(v||{})); }

/* #65 付与 */
function grantSecret65(){
  const dex = loadDex();
  dex.unlocked = Object.assign({}, dex.unlocked, { [SECRET65_ID]: true });
  dex.secret65 = SECRET_FILE;               // 解放後に使う実体ファイル名
  if (!dex.selected) dex.selected = SECRET_FILE;
  saveDex(dex);
  try { window.dispatchEvent(new StorageEvent('storage', {key: DEX_KEY, newValue: JSON.stringify(dex)})); } catch(_){}
}

/* ベスト更新（通常） */
function updateArcadeBest(raw){
  const norm = Math.round(raw * 3); // 1000 → 3000（既存の300..3400閾値に整合）
  const curA = +(localStorage.getItem(ARCADE_KEY)||0);
  if (norm > curA) localStorage.setItem(ARCADE_KEY, String(norm));
  const curR = +(localStorage.getItem(RHYTHM_KEY)||0);
  if (raw > curR)  localStorage.setItem(RHYTHM_KEY, String(raw));
  try { window.dispatchEvent(new StorageEvent('storage', {key: ARCADE_KEY, newValue: String(Math.max(curA,norm))})); } catch(_){}
}

/* ===== Canvas ===== */
const cv  = document.getElementById('cv');
const ctx = cv.getContext('2d');
function fitCanvas(){
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
  const w = cv.clientWidth, h = cv.clientHeight;
  cv.width = w*dpr; cv.height = h*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize', fitCanvas, {passive:true});
fitCanvas();

/* ===== UI ===== */
const scoreEl       = document.getElementById('score');
const bestEl        = document.getElementById('best');
const startNormal   = document.getElementById('startNormal');
const startChallenge= document.getElementById('startChallenge');
const goalText      = document.getElementById('goalText');

bestEl.textContent = localStorage.getItem(RHYTHM_KEY)||'0';

/* ===== Game State ===== */
const LANES = 4;
const keys  = ['a','s','k','l'];
const laneX = i => (cv.clientWidth*(i+0.5))/LANES;
const hitY  = () => cv.clientHeight-86;

let notes=[], t0=0, playing=false, paused=false, score=0, combo=0, raf=0, mode='normal';
let pausedAt = 0;

/* 譜面生成：BPM徐々上げ＋8分主体 */
function makeChart(){
  notes.length=0;
  let t=0, bpm=120;
  for(let m=0;m<36;m++){
    if (m===8)  bpm=140;
    if (m===16) bpm=160;
    if (m===24) bpm=180;
    if (m===32) bpm=200;
    const spb = 60/bpm;

    const patterns = [
      [0, 0.5],
      [0, 0.5, 0.75],
      [0, 0.25, 0.5, 0.75],
      [0, 0.5, 1.0],
    ];
    const pat = patterns[Math.floor(Math.random()*patterns.length)];

    const used = new Set();
    for(const p of pat){
      let lane = Math.floor(Math.random()*LANES);
      const key = `${t+p}-${lane}`;
      if (used.has(key)) lane = (lane + 1 + Math.floor(Math.random()*3)) % LANES;
      used.add(`${t+p}-${lane}`);
      notes.push({t: t + p*spb*2, lane, hit:false});
    }
    t += spb*2;
  }
}

function tryHit(lane){
  if (!playing || paused) return;
  const now = (performance.now()-t0)/1000;
  let bestIdx=-1, bestAbs=999;
  for(let i=0;i<notes.length;i++){
    const n = notes[i];
    if (n.hit || n.lane!==lane) continue;
    const dy = Math.abs(n.t - now);
    if (dy < 0.12 && dy < bestAbs){ bestAbs = dy; bestIdx=i; }
  }
  if (bestIdx>=0){
    notes[bestIdx].hit = true;
    let add = 0;
    if (bestAbs < 0.04){ add = 30; combo++; }        // PERFECT
    else if (bestAbs < 0.08){ add = 20; combo++; }   // GREAT
    else { add = 10; combo=0; }                      // GOOD
    add += Math.floor(combo/5)*2;                    // combo bonus
    score = Math.min(1000, score + add);
    scoreEl.textContent = score;
  }else{
    combo = 0;
  }
}

cv.addEventListener('pointerdown', (e)=>{
  if (!playing) return;
  const x = e.offsetX, w=cv.clientWidth;
  const lane = Math.floor(x / (w/LANES));
  tryHit(lane);
}, {passive:true});

window.addEventListener('keydown', (e)=>{
  const k = e.key.toLowerCase();
  if (k === ' '){
    if (!playing) return;
    e.preventDefault();
    paused = !paused;
    if (!paused){ t0 = performance.now() - pausedAt; loop(performance.now()); }
    else        { pausedAt = performance.now() - t0; }
    return;
  }
  const lane = keys.indexOf(k);
  if (lane>=0) tryHit(lane);
});

/* 描画 */
function draw(now){
  ctx.clearRect(0,0,cv.clientWidth,cv.clientHeight);
  // lanes
  for(let i=0;i<LANES;i++){
    ctx.fillStyle = 'rgba(12,26,43,.9)';
    const lw = cv.clientWidth/LANES - 10;
    ctx.fillRect(i*(cv.clientWidth/LANES)+5, 10, lw, cv.clientHeight-20);
    ctx.fillStyle = '#9ca3af';
    ctx.font = 'bold 14px system-ui';
    ctx.fillText(keys[i].toUpperCase(), i*(cv.clientWidth/LANES)+10, 26);
  }
  // hit line
  ctx.strokeStyle = '#22c55e';
  ctx.beginPath(); ctx.moveTo(0, hitY()); ctx.lineTo(cv.clientWidth, hitY()); ctx.stroke();

  // notes
  const speed = 330;
  for(const n of notes){
    if (n.hit) continue;
    const dt = n.t - now;
    const y  = hitY() - dt*speed;
    if (y < -30 || y > cv.clientHeight+30) continue;
    const x = laneX(n.lane);
    ctx.fillStyle = y>hitY()+12 ? '#ef4444' : '#22d3ee';
    ctx.fillRect(x-18, y-12, 36, 24);
  }

  // combo
  if (combo>0){
    ctx.fillStyle = '#eab308';
    ctx.font = 'bold 18px system-ui';
    ctx.fillText(`${combo} COMBO`, 10, 48);
  }

  if (paused){
    ctx.fillStyle = 'rgba(0,0,0,.45)';
    ctx.fillRect(0,0,cv.clientWidth,cv.clientHeight);
    ctx.fillStyle = '#e5e7eb';
    ctx.font = 'bold 24px system-ui';
    ctx.fillText('PAUSED', cv.clientWidth/2-50, cv.clientHeight/2);
  }
}

function loop(ts){
  if (!playing) return;
  if (paused){ raf = requestAnimationFrame(loop); return; }

  const now = (ts - t0)/1000;
  draw(now);

  // miss after 100ms past line
  for (const n of notes){
    if (!n.hit && n.t < now - 0.10){ n.hit=true; combo=0; }
  }

  // end condition
  if (notes.length && now > notes[notes.length-1].t + 1.0){
    playing=false;
    const raw = Math.min(1000, Math.max(0, score));
    // 通常ベスト更新
    updateArcadeBest(raw);
    // CHALLENGE判定
    if (mode==='challenge' && raw >= SECRET_TARGET){
      grantSecret65();
      alert(`#65 解放！（スコア ${raw}） 図鑑に戻ります`);
      location.href = '../dex/index.html';
      return;
    }else if(mode==='challenge'){
      alert(`未達成…（${raw}/${SECRET_TARGET}） もう一度！`);
    }
    bestEl.textContent = localStorage.getItem(RHYTHM_KEY)||'0';
    startNormal.disabled = false;
    startChallenge.disabled = false;
    return;
  }
  raf = requestAnimationFrame(loop);
}

/* スタート */
function start(kind){
  mode = kind; score=0; combo=0; scoreEl.textContent='0';
  makeChart(); t0 = performance.now(); paused=false; playing=true;
  startNormal.disabled = true; startChallenge.disabled = true;
  cancelAnimationFrame(raf);
  loop(performance.now());
}

document.getElementById('startNormal').addEventListener('click', ()=> start('normal'));
document.getElementById('startChallenge').addEventListener('click', ()=> start('challenge'));

/* 画面非表示で一時停止 */
document.addEventListener('visibilitychange', ()=>{
  if (!playing) return;
  if (document.hidden){
    paused = true; pausedAt = performance.now() - t0;
  }else{
    t0 = performance.now() - pausedAt; paused=false;
  }
});
</script>
</body>
</html>
