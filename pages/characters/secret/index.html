<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>挑戦モード</title>
<style>
  :root{--bg:#0b1220;--ink:#e5e7eb;--card:#111827;--line:#243042;--accent:#10b981}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui}
  .wrap{max-width:800px;margin:24px auto;padding:16px}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
  .row{display:flex;gap:10px;align-items:center}
  .btn{background:var(--accent);color:#052017;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  canvas{display:block;width:100%;height:360px;background:radial-gradient(#0f2238,#0b1626)}
  .muted{color:#9ca3af}
</style>
</head>
<body>
<div class="wrap">
  <h1>挑戦モード</h1>
  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <div>10秒生き残れば解放！</div>
      <button class="btn" id="startBtn">START</button>
    </div>
    <canvas id="cv" width="800" height="360"></canvas>
    <div class="row" style="justify-content:space-between">
      <div>タイム：<span id="time">0.0</span>s</div>
      <a href="../dex/index.html" class="muted">図鑑へ戻る</a>
    </div>
  </div>
</div>

<script>
const DEX_KEY = 'dex_state_v1';
const SECRET65_ID = 64;             // #65
const SECRET_FILENAME = 'secret_65.png';

function loadDex(){ try{ return JSON.parse(localStorage.getItem(DEX_KEY)||'{}'); }catch{ return {}; } }
function saveDex(v){ localStorage.setItem(DEX_KEY, JSON.stringify(v||{})); }

function grantSecret65(){
  const dex = loadDex();
  dex.unlocked = Object.assign({}, dex.unlocked, { [SECRET65_ID]: true });
  dex.secret65 = SECRET_FILENAME;   // ← ファイル名をここで初めて注入
  if (!dex.selected) dex.selected = SECRET_FILENAME; // 初回は自動で選択してあげる
  saveDex(dex);
}

const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
const startBtn = document.getElementById('startBtn');
const timeEl = document.getElementById('time');

let playing = false, t0 = 0, anim=0;
let px=60, py=cv.height-40, vy=0, onGround=true;
let hazards = [];

function resetGame(){
  playing = false; timeEl.textContent = '0.0';
  px=60; py=cv.height-40; vy=0; onGround=true;
  hazards = [];
  ctx.clearRect(0,0,cv.width,cv.height);
  drawScene(0);
}

function drawScene(elapsed){
  // ground
  ctx.fillStyle = '#0e243a';
  ctx.fillRect(0, cv.height-24, cv.width, 24);

  // player
  ctx.fillStyle = '#22d3ee';
  ctx.fillRect(px-10, py-20, 20, 20);

  // hazards
  ctx.fillStyle = '#ef4444';
  hazards.forEach(h=> ctx.fillRect(h.x-10, h.y-10, 20, 20));

  // text
  ctx.fillStyle = '#9ca3af';
  ctx.fillText(`survive 10s`, 12, 18);
}

function spawnHazard(){
  const y = cv.height-34;
  hazards.push({ x: cv.width+20, y, v: 2.6 + Math.random()*1.2 });
}

function loop(ts){
  if (!playing) return;
  if (!t0) t0 = ts;
  const elapsed = (ts - t0)/1000;
  timeEl.textContent = elapsed.toFixed(1);

  // clear
  ctx.clearRect(0,0,cv.width,cv.height);

  // gravity & jump
  vy += 0.35;
  py += vy;
  if (py >= cv.height-40){ py=cv.height-40; vy=0; onGround=true; }
  // move hazards
  hazards.forEach(h=> h.x -= h.v);
  hazards = hazards.filter(h=> h.x > -20);
  // spawn
  if (Math.random() < 0.03) spawnHazard();

  // collision
  for(const h of hazards){
    if (Math.abs(h.x - px) < 18 && Math.abs(h.y - py) < 18){
      // fail
      playing = false;
      alert('失敗…もう一度挑戦！');
      resetGame();
      return;
    }
  }

  drawScene(elapsed);

  // clear condition
  if (elapsed >= 10){
    playing = false;
    grantSecret65();
    alert('解放！図鑑で #65 が使えるようになったよ');
    // 図鑑へ戻る
    location.href = '../dex/index.html';
    return;
  }

  anim = requestAnimationFrame(loop);
}

// jump
cv.addEventListener('pointerdown', ()=>{
  if (!playing) return;
  if (onGround){ vy = -7.5; onGround = false; }
});

startBtn.addEventListener('click', ()=>{
  cancelAnimationFrame(anim); t0 = 0;
  playing = true; hazards = []; vy=0; onGround=true; py=cv.height-40;
  loop(performance.now());
});

resetGame();
</script>
</body>
</html>
