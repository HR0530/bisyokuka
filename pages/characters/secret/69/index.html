<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Secret #69：レーザー・ガントレット（激むず）</title>
<style>
  :root{
    --bg:#0b1220;--ink:#e5e7eb;--card:#111827;--line:#243042;
    --accent:#f59e0b;--ok:#22c55e;--warn:#ef4444;--muted:#9ca3af
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    overscroll-behavior: none; /* ← 矢印/スペースでスクロール抑制に寄与 */
  }
  .wrap{max-width:1000px;margin:24px auto;padding:16px}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;position:relative}
  .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .left{display:flex;gap:10px;align-items:center}
  .right{display:flex;gap:10px;align-items:center}
  .btn{
    background:var(--accent);color:#221a05;border:none;border-radius:10px;
    padding:10px 14px;font-weight:800;cursor:pointer;text-decoration:none;display:inline-block
  }
  .btn.ghost{background:#0ea5e9;color:#031423}
  .btn.red{background:#ef4444;color:#120606}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted);text-decoration:none}
  .stats{display:flex;gap:16px;align-items:center}
  .badge{background:#0b1626;border:1px solid #1a2740;border-radius:999px;padding:6px 10px;font-weight:700}
  canvas{
    display:block;width:100%;
    height:clamp(360px, calc(100svh - 260px), 680px);
    margin-top:10px;
    background:linear-gradient(#0f2238,#0b1626);
    border-radius:12px;border:1px solid #1a2740
  }
  @media (max-width:640px){ canvas{height:420px} }

  .overlay{
    position:absolute;inset:0;display:none;place-items:center;
    background:rgba(0,0,0,.45)
  }
  .overlay .sheet{
    background:#111827;border:1px solid #243042;border-radius:14px;padding:16px;min-width:60%;
    display:grid;gap:12px;justify-items:center
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Secret #69：レーザー・ガントレット（激むず）</h1>
  <div class="panel">
    <div class="row">
      <div class="left">
        <button class="btn" id="startBtn">START</button>
        <a class="btn ghost" id="backLink" href="#">図鑑へ戻る</a>
        <button class="btn red" id="resetBtn" title="#69 の解放状態だけ初期化">#69解放リセット</button>
      </div>
      <div class="right stats">
        <span class="badge">ゴールに到達せよ</span>
        <span>タイム：<b id="time">0.0</b>s</span>
        <span>進捗：<b id="prog">0</b>%</span>
      </div>
    </div>

    <canvas id="cv"></canvas>

    <!-- 失敗・成功オーバーレイ -->
    <div class="overlay" id="ov">
      <div class="sheet">
        <div id="ovMsg" style="font-weight:800;font-size:18px"></div>
        <div class="muted" id="ovSub"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
          <button class="btn" id="retryBtn">もう一度</button>
          <a class="btn ghost" id="backLink2" href="#">図鑑へ</a>
        </div>
      </div>
    </div>
  </div>

  <div class="muted" style="margin-top:8px;line-height:1.6">
    操作：<b>SPACE / 画面タップ</b>でジャンプ（<b>2段ジャンプ</b>）。  
    レーザーは断続的に停止します。狭い足場やノコギリを越えつつゲートの“停止時間”に滑り込め！
  </div>
</div>

<script>
/* ========= ルーティング（図鑑への確実な戻り先） ========= */
function resolveDexPath(){
  const p = location.pathname;
  if (p.includes('/pages/characters/secret/')) return '../../dex/index.html';
  if (p.includes('/pages/characters/'))       return '../dex/index.html';
  if (p.includes('/pages/'))                  return 'characters/dex/index.html';
  return 'pages/characters/dex/index.html';
}
document.getElementById('backLink').href  = resolveDexPath();
document.getElementById('backLink2').href = resolveDexPath();

/* ========= ストレージ（#69 のみ解放） ========= */
const DEX_KEY   = 'dex_state_v1';
const SECRET_ID = 68;              // 0始まり → #69
const SECRET_FN = 'secret_69.png'; // project-root に配置

function loadDex(){ try{ return JSON.parse(localStorage.getItem(DEX_KEY)||'{}'); }catch{ return {}; } }
function saveDex(v){ localStorage.setItem(DEX_KEY, JSON.stringify(v||{})); }
function grantSecret69(){
  const dex = loadDex();
  dex.unlocked    = Object.assign({}, dex.unlocked, { [SECRET_ID]: true });
  dex.secretFiles = Object.assign({}, dex.secretFiles, { [SECRET_ID]: SECRET_FN });
  if (!dex.selected) dex.selected = SECRET_FN;
  saveDex(dex);
  try{ window.dispatchEvent(new StorageEvent('storage', {key:DEX_KEY, newValue:JSON.stringify(dex)})); }catch(_){}
}
function resetSecret69(){
  const dex = loadDex();
  if (dex.unlocked)    delete dex.unlocked[SECRET_ID];
  if (dex.secretFiles) delete dex.secretFiles[SECRET_ID];
  // selected は弄らない（他キャラ使用中かもしれないため）
  saveDex(dex);
  try{ window.dispatchEvent(new StorageEvent('storage', {key:DEX_KEY, newValue:JSON.stringify(dex)})); }catch(_){}
}

/* ========= Canvas（高DPI） ========= */
const cv  = document.getElementById('cv');
const ctx = cv.getContext('2d');
function fitCanvas(){
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
  const w = cv.clientWidth, h = cv.clientHeight;
  cv.width = Math.floor(w*dpr); cv.height = Math.floor(h*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener('resize', fitCanvas, {passive:true});
fitCanvas();

/* ========= 入力：スペース/タップでジャンプ。スクロール抑止 ========= */
function preventScrollKeys(e){
  if (e.code==='Space' || e.code==='ArrowUp' || e.code==='ArrowDown' || e.code==='ArrowLeft' || e.code==='ArrowRight'){
    e.preventDefault();
  }
}
addEventListener('keydown', preventScrollKeys, {passive:false});

/* ========= DOM ========= */
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const timeEl   = document.getElementById('time');
const progEl   = document.getElementById('prog');
const ov       = document.getElementById('ov');
const ovMsg    = document.getElementById('ovMsg');
const ovSub    = document.getElementById('ovSub');
const retryBtn = document.getElementById('retryBtn');

/* ========= ゲーム定数（激むず・到達可能に調整済み） ========= */
const GROUND_H   = 28;
const PW         = 22, PH = 26;
const GRAVITY    = 1400;   // px/s^2
const JUMP_V     = -520;   // 1段目
const DJUMP_V    = -500;   // 2段目
const SPEED      = 270;    // 一定速度（難易度調整）
const HIT_F      = 2;      // 当たり判定ゆるみ
const WORLD_LEN  = 5200;   // ゴール x
const UNIT       = () => Math.max(24, Math.floor(cv.clientHeight/14));

/* レーザー（縦シャッター）：周期と停止窓 */
const L_PERIOD   = 2.2;    // 周期[s]
const L_OFF_DUR  = 0.95;   // 停止時間（通過可）[s] ← 難しすぎないよう拡大
const GATE_GAP   = 620;    // ゲート間隔(px)
const GATE_W     = 16;

/* ノコギリ（横移動障害） */
const SAW_R      = 12;
const SAW_SPEED  = 90;

/* ピット（落下穴） */
const PIT_MIN    = 120, PIT_MAX = 180; // 幅
const PIT_GAP    = 380; // ピットの基本間隔

/* ========= 状態 ========= */
let playing=false, t0=0, last=0, raf=0;
let timeNow=0, prog=0;
let px=90, py=0, vy=0, onGround=false, jumps=2;
let camX=0;

let pits=[], lasers=[], saws=[], goal=null;

/* ========= ステージ生成（到達可能な配置） ========= */
function buildStage(){
  pits.length = 0; lasers.length = 0; saws.length = 0; goal = null;

  // ピット：序盤控えめ → 中盤〜後半は連打
  let x = 600;
  while (x < WORLD_LEN - 800){
    const w = PIT_MIN + Math.random()*(PIT_MAX-PIT_MIN);
    pits.push({x, w});
    x += PIT_GAP + (Math.random()*140 - 20); // 少しズレ
  }

  // レーザーゲート（縦シャッター）
  // 到着予測時刻に停止窓が来るように phase を調整
  let gx = 900, gateIndex = 0;
  while (gx < WORLD_LEN - 400){
    const arrive = gx / SPEED;              // 単純到着予測（ジャンプロスを見込んで −0.2s 余裕）
    const ideal  = (arrive - 0.2) % L_PERIOD;
    const phase  = (L_PERIOD - ideal) % L_PERIOD; // t=0 から開始したときに ”OFF開始” が来るよう調整
    lasers.push({x:gx, w:GATE_W, phase, period:L_PERIOD, off:L_OFF_DUR});
    gx += GATE_GAP + (gateIndex%2 ? 20 : -10); // 微妙に間隔を揺らす
    gateIndex++;
  }

  // ノコギリ群：ピット直後の浮遊イヤらし配置
  for (let i=0;i<6;i++){
    const sx = 1200 + i*700 + (Math.random()*120-60);
    const baseY = groundY() - (70 + Math.random()*90);
    const amp   = 18 + Math.random()*14;
    saws.push({x:sx, baseY, amp, t:0});
  }

  // ゴール
  goal = {x: WORLD_LEN, w: UNIT()*1.2, h: UNIT()*1.6};
}

/* ========= 床Y ========= */
function groundY(){ return cv.clientHeight - GROUND_H; }

/* ========= リセット ========= */
function resetGame(){
  cancelAnimationFrame(raf);
  playing=false; t0=0; last=0; timeNow=0; prog=0;
  px=90; py=groundY()-PH; vy=0; onGround=true; jumps=2; camX=0;
  timeEl.textContent='0.0'; progEl.textContent='0';
  buildStage();
  drawScene();
  ov.style.display='none';
}

/* ========= 物理・当たり判定 ========= */
function rectOverlap(ax,ay,aw,ah,bx,by,bw,bh, f=0){
  return !(ax+aw - f < bx || ax + f > bx+bw || ay+ah - f < by || ay + f > by+bh);
}
function pitAt(xCenter){
  for (const p of pits){
    if (xCenter >= p.x && xCenter <= p.x + p.w) return p;
  }
  return null;
}
function laserActive(L, t){
  const tt = (t + L.phase) % L.period;
  // 0..off: OFF(安全) / off..period: ON(危険)
  return !(tt <= L.off);
}

/* ========= 入力 ========= */
function jump(){
  if (!playing) return;
  if (onGround){
    vy = JUMP_V; onGround=false; jumps=1; return;
  }
  if (jumps > 0){
    vy = DJUMP_V; jumps = 0;
  }
}
cv.addEventListener('pointerdown', jump, {passive:true});
addEventListener('keydown', (e)=>{ if (e.code==='Space'){ e.preventDefault(); jump(); }}, {passive:false});

/* ========= ループ ========= */
function loop(ts){
  if (!playing) return;
  if (!last) last = ts;
  const dt = Math.min(0.033, (ts - last)/1000);
  last = ts;

  timeNow = (ts - t0)/1000;
  timeEl.textContent = timeNow.toFixed(1);

  // 速度一定・前進
  const vx = SPEED*dt;
  px += vx;

  // ピットの上か判定 → 地面Y切り替え
  const gy = groundY() - PH;
  const inPit = pitAt(px + PW/2);
  if (inPit){
    // 落下空間（床なし）
  }else{
    // 床あり（高さ一定）
    if (py >= gy){ py=gy; vy=0; if(!onGround){ onGround=true; jumps=2; } }
  }

  // 重力
  vy += GRAVITY*dt;
  py += vy*dt;

  // 下に落ち過ぎたら失敗
  if (py > cv.clientHeight + UNIT()*4){
    fail('奈落に落ちた…'); return;
  }

  // ノコギリは横移動なし・縦にうねる
  saws.forEach(s=> s.t += dt);

  // 衝突：レーザー（ON時のみ）
  for (const L of lasers){
    if (px + PW < L.x - GATE_W*2 || px > L.x + GATE_W*2) continue;
    if (laserActive(L, timeNow)){
      if (rectOverlap(px, py, PW, PH, L.x - GATE_W/2, 0, GATE_W, cv.clientHeight, HIT_F)){
        fail('レーザーに焼かれた…'); return;
      }
    }
  }

  // 衝突：ノコギリ
  for (const s of saws){
    const sy = s.baseY + Math.sin(s.t*2.6)*s.amp;
    const sb = {x:s.x - SAW_R, y:sy - SAW_R, w:SAW_R*2, h:SAW_R*2};
    if (rectOverlap(px,py,PW,PH,sb.x,sb.y,sb.w,sb.h,HIT_F)){
      fail('ノコギリに当たった…'); return;
    }
  }

  // カメラ（プレイヤーを画面の40%位置付近に）
  const worldRight = goal ? goal.x + goal.w + UNIT()*3 : cv.clientWidth;
  const target = px - cv.clientWidth*0.4;
  camX = Math.max(0, Math.min(target, Math.max(0, worldRight - cv.clientWidth)));

  // 進捗%
  prog = Math.max(0, Math.min(100, Math.round(px / WORLD_LEN * 100)));
  progEl.textContent = prog;

  // ゴール判定
  if (px + PW >= goal.x && py + PH >= groundY() - goal.h){
    success(); return;
  }

  drawScene();
  raf = requestAnimationFrame(loop);
}

/* ========= 描画 ========= */
function drawScene(){
  const w = cv.clientWidth, h=cv.clientHeight;
  ctx.clearRect(0,0,w,h);

  // 背景
  const grad = ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,'#10253f'); grad.addColorStop(1,'#0c182b');
  ctx.fillStyle = grad; ctx.fillRect(0,0,w,h);

  // 地面ライン
  ctx.fillStyle = '#0e243a';
  ctx.fillRect(0, h-GROUND_H, w, GROUND_H);

  // ピット（穴）
  ctx.fillStyle = '#061220';
  pits.forEach(p=>{
    const x = p.x - camX;
    ctx.fillRect(x, h-GROUND_H, p.w, GROUND_H);
  });

  // レーザー支柱
  ctx.fillStyle = '#1f2d46';
  lasers.forEach(L=>{
    const x = L.x - camX - GATE_W/2;
    ctx.fillRect(x-6, 0, 6, h);
    ctx.fillRect(x+GATE_W, 0, 6, h);
  });

  // レーザービーム（ONの時だけ）
  lasers.forEach(L=>{
    if (!laserActive(L, timeNow)) return;
    const x = L.x - camX - GATE_W/2;
    ctx.fillStyle = 'rgba(239,68,68,0.9)';
    ctx.fillRect(x, 0, GATE_W, h);
    // グロー
    const g = ctx.createLinearGradient(x,0,x+GATE_W,0);
    g.addColorStop(0,'rgba(239,68,68,0.15)');
    g.addColorStop(0.5,'rgba(239,68,68,0.35)');
    g.addColorStop(1,'rgba(239,68,68,0.15)');
    ctx.fillStyle = g;
    ctx.fillRect(x-10,0,GATE_W+20,h);
  });

  // ノコギリ
  saws.forEach(s=>{
    const x = s.x - camX, y = s.baseY + Math.sin(s.t*2.6)*s.amp;
    ctx.save();
    ctx.translate(x, y);
    ctx.fillStyle = '#ef4444';
    const teeth = 8;
    for(let i=0;i<teeth;i++){
      ctx.rotate(Math.PI*2/teeth);
      ctx.beginPath();
      ctx.moveTo(0,0); ctx.lineTo(0,-SAW_R); ctx.lineTo(SAW_R*0.75,-SAW_R*0.65); ctx.closePath();
      ctx.fill();
    }
    ctx.restore();
  });

  // ゴールポール
  if (goal){
    const gx = goal.x - camX;
    ctx.fillStyle = '#22c55e';
    ctx.fillRect(gx, groundY()-goal.h, 6, goal.h);
    ctx.fillStyle = '#86efac';
    ctx.fillRect(gx+6, groundY()-goal.h, goal.w-6, 10);
  }

  // プレイヤー
  ctx.fillStyle = '#22d3ee';
  ctx.fillRect(px - camX, py, PW, PH);

  // ガイドライン（中央）
  ctx.strokeStyle = 'rgba(255,255,255,.10)';
  ctx.beginPath(); ctx.moveTo(w*0.4,0); ctx.lineTo(w*0.4,h); ctx.stroke();
}

/* ========= 成否 ========= */
function fail(msg){
  playing=false;
  ovMsg.textContent = '失敗…';
  ovSub.textContent = msg + '（レーザーは一定時間止まる。タイミングを見切れ！）';
  ov.style.display = 'grid';
}
function success(){
  playing=false;
  grantSecret69();
  ovMsg.textContent = '解放成功！ #69 が使えるようになった';
  ovSub.textContent = '図鑑で選択できます。';
  ov.style.display = 'grid';
}

/* ========= 開始 ========= */
function start(){
  resetGame();
  playing=true;
  t0 = performance.now(); last = t0;
  raf = requestAnimationFrame(loop);
}

startBtn.addEventListener('click', start);
retryBtn.addEventListener('click', start);
resetBtn.addEventListener('click', ()=>{
  if (confirm('本当に #69 の解放をリセットしますか？')){
    resetSecret69();
    alert('リセットしました。');
  }
});

/* 初期化 */
resetGame();
</script>
</body>
</html>
