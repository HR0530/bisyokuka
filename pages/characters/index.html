<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¾é£Ÿå®¶ã•ã‚“ - ã‚­ãƒ£ãƒ©è‚²æˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --line:#1f2937;
      --brand:#0ea5e9; --ok:#22c55e; --warn:#f59e0b; --accent:#f97316;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:#ffbb54;text-decoration:none}
    .wrap{width:92%;max-width:880px;margin:16px auto 28px;display:grid;gap:14px}

    /* Top: gauge + title */
    .top{
      background:var(--card);border:1px solid var(--line);border-radius:14px;
      padding:14px; display:grid; gap:10px
    }
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .title{font-weight:800;font-size:18px}
    .badge{display:inline-block;background:#0b1220;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-size:12px;color:#cbd5e1}

    .gauge{position:relative;height:14px;border-radius:999px;background:#0b1220;border:1px solid var(--line);overflow:hidden}
    .gbar{position:absolute;inset:0;height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#0ea5e9)}
    .glabel{font-size:12px;color:#cbd5e1}

    /* Middle: character + bubble */
    .stage{
      background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;
      display:grid;justify-items:center;gap:12px; text-align:center
    }
    .char{
      width:140px;height:140px; background:#0b1220;border:1px solid var(--line);border-radius:16px;
      display:grid;place-items:center; overflow:hidden; position:relative; box-shadow:0 8px 28px rgba(0,0,0,.28)
      animation:bob 3s ease-in-out infinite;
    }
    .char img{width:72px;image-rendering:pixelated}
    @keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .bubble{
      position:relative; background:#0ea5e9; color:#031422; border-radius:12px; padding:10px 12px; max-width:580px;
      box-shadow:0 10px 30px rgba(0,0,0,.25); font-weight:700
    }
    .bubble::after{
      content:""; position:absolute; left:50%; transform:translateX(-50%); top:100%;
      border:8px solid transparent; border-top-color:#0ea5e9;
    }

    /* Quests / Challenges */
    .section{display:grid;gap:10px}
    .section h2{margin:2px 0 0;font-size:16px}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:10px}
    .card{
      background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:12px;display:grid;gap:10px
    }
    .card .head{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .label{color:#cbd5e1;font-weight:700}
    .small{font-size:12px;color:#94a3b8}
    .cta{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:var(--brand);color:#031422;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#0e1626;color:#e5e7eb;border:1px solid var(--line)}
    .ok{color:#22c55e}
    .warn{color:#fbbf24}
    .danger{color:#f87171}
    .footer{display:flex;gap:10px;justify-content:center;margin-top:6px}
  </style>
</head>
<body>
<div class="wrap">
  <!-- ===== Top ===== -->
  <section class="top">
    <div class="row">
      <div class="title">ğŸ‘¤ ã‚­ãƒ£ãƒ©è‚²æˆ</div>
      <div>
        <span class="badge" id="titleBadge">ç§°å·: ãƒ“ã‚®ãƒŠãƒ¼ç¾é£Ÿå®¶</span>
        <span class="badge">è§£æ”¾ã‚­ãƒ£ãƒ© <span id="unlockedNum">0</span>/32</span>
      </div>
    </div>
    <div class="gauge"><div id="gbar" class="gbar"></div></div>
    <div class="glabel">æœ¬æ—¥ã®ãƒãƒ©ãƒ³ã‚¹åº¦: <b id="balanceScore">0</b> / 100ï¼ˆç›®æ¨™PFCã«è¿‘ã„ã»ã©UPï¼‰</div>
  </section>

  <!-- ===== Stage ===== -->
  <section class="stage">
    <div class="char">
      <!-- å¥½ããªã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã«å·®ã—æ›¿ãˆã¦OK -->
      <img id="charImg" src="../dex/../characters/img/char01.png" alt="ã‚­ãƒ£ãƒ©">
    </div>
    <div id="bubble" class="bubble">ã“ã‚“ã«ã¡ã¯ï¼ä»Šæ—¥ã‚‚ãŠã„ã—ãã€ãƒãƒ©ãƒ³ã‚¹ã‚ˆãé£Ÿã¹ã‚ˆã†ã€‚</div>
    <div class="cta">
      <button class="btn" onclick="goMeal()">ğŸ“· é£Ÿäº‹ã‚’è¨˜éŒ²ã™ã‚‹</button>
      <button class="btn secondary" onclick="goInsights()">ğŸ“Š åˆ†æã‚’è¦‹ã‚‹</button>
      <button class="btn secondary" onclick="goDex()">ğŸ“š å›³é‘‘ã‚’è¦‹ã‚‹</button>
    </div>
  </section>

  <!-- ===== Daily Quests ===== -->
  <section class="section">
    <h2>ğŸ¯ ãƒ‡ã‚¤ãƒªãƒ¼ã‚¯ã‚¨ã‚¹ãƒˆï¼ˆä»Šæ—¥ï¼‰</h2>
    <div id="questList" class="cards"></div>
  </section>

  <!-- ===== Weekly Challenges ===== -->
  <section class="section">
    <h2>ğŸ† ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h2>
    <div id="challengeList" class="cards"></div>
  </section>

  <div class="footer">
    <a href="../../index.html">â† ãƒ›ãƒ¼ãƒ </a>
  </div>
</div>

<script>
/* ========== æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­è¾¼ ========== */
const MEAL_KEY   = "bisyokuka_meals_v2";
const UNLOCK_KEY = "bisyokuka_unlocked_chars";
const meals = JSON.parse(localStorage.getItem(MEAL_KEY) || "[]");
const unlockedChars = parseInt(localStorage.getItem(UNLOCK_KEY) || "0", 10);

/* ç›®æ¨™å€¤ï¼ˆkcalã¯è¨­å®šç”»é¢ã®å€¤ã€‚PFCæ¯”ç‡ã¯æœªè¨­å®šãªã‚‰ 20/25/55ï¼‰ */
const calorieGoal = parseInt(localStorage.getItem("calorieGoal") || "1580", 10);
const ratio = JSON.parse(localStorage.getItem("pfcRatio") || "{\"p\":0.20,\"f\":0.25,\"c\":0.55}");
const target = {
  kcal: calorieGoal,
  protein: Math.round((calorieGoal*ratio.p)/4),
  fat:     Math.round((calorieGoal*ratio.f)/9),
  carbs:   Math.round((calorieGoal*ratio.c)/4),
};

/* ========== é›†è¨ˆï¼ˆä»Šæ—¥ï¼‰ ========== */
const todayKey = new Date().toISOString().slice(0,10);
const todayMeals = meals.filter(m => (m.date||"").slice(0,10) === todayKey);

const today = todayMeals.reduce((a,m)=>({
  kcal:   a.kcal   + Number(m.totals?.kcal   || 0),
  protein:a.protein+ Number(m.totals?.protein|| 0),
  fat:    a.fat    + Number(m.totals?.fat    || 0),
  carbs:  a.carbs  + Number(m.totals?.carbs  || 0),
}), {kcal:0,protein:0,fat:0,carbs:0});

/* ========== ãƒãƒ©ãƒ³ã‚¹åº¦ï¼ˆ0-100ï¼‰ ==========
   å„æ „é¤Šç´ ã® â€œç›®æ¨™ã«å¯¾ã™ã‚‹é”æˆç‡â€ ã‚’å¹³å‡ã€‚
   é”æˆç‡ = clamp( 1 - |å®Ÿç¸¾-ç›®æ¨™| / ç›®æ¨™ , 0, 1 )
*/
function score(actual, target){
  if(target<=0) return 100;
  const acc = Math.max(0, 1 - Math.abs(actual-target)/target);
  return acc*100;
}
const sP = score(today.protein, target.protein);
const sF = score(today.fat,     target.fat);
const sC = score(today.carbs,   target.carbs);
const balance = Math.round((sP + sF + sC) / 3);

/* ========== ç§°å· ========== */
function calcTitle(unlocked, bal){
  if(unlocked >= 32) return "å›³é‘‘ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã®é”äºº";
  if(unlocked >= 20) return "å‘³è¦šãƒã‚¹ã‚¿ãƒ¼";
  if(unlocked >= 10) return "ã‚°ãƒ«ãƒ¡ç ”ç©¶å“¡";
  if(unlocked >= 5 ) return "é£Ÿæ¢æ¤œå®¶";
  if(bal >= 85)      return "æ „é¤Šãƒãƒ©ãƒ³ã‚µãƒ¼";
  return "ãƒ“ã‚®ãƒŠãƒ¼ç¾é£Ÿå®¶";
}

/* ========== å¹ãå‡ºã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ========== */
function talk(){
  const lack = {
    protein: target.protein - today.protein,
    fat:     target.fat     - today.fat,
    carbs:   target.carbs   - today.carbs,
  };
  const tips = [];
  if(lack.protein > 10) tips.push(`ãŸã‚“ã±ãè³ªã‚’ã‚ã¨ ${Math.round(lack.protein)}gï¼é¶ã‚€ã­ãƒ»è±†è…ãƒ»ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆãŒãŠã™ã™ã‚`);
  if(lack.carbs   > 20) tips.push(`ç‚­æ°´åŒ–ç‰©ã‚’ã‚ã¨ ${Math.round(lack.carbs)}gã€‚ã”ã¯ã‚“ã‚„å…¨ç²’ç²‰ãƒ‘ãƒ³ã‚’å°‘ã—è¿½åŠ ã—ã‚ˆã†`);
  if(lack.fat     > 10) tips.push(`è„‚è³ªã¯ ${Math.round(lack.fat)}g ä¸è¶³ã€‚ãƒŠãƒƒãƒ„ã‚„ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«ã§è³ªã®è‰¯ã„è„‚ã‚’`);
  if(tips.length===0){
    if(balance>=85) return "ãƒãƒ©ãƒ³ã‚¹æœ€é«˜ï¼ã“ã®èª¿å­ã§ã„ã“ã†âœ¨";
    if(balance>=60) return "æ‚ªããªã„ã‚ˆã€‚ã‚‚ã†ä¸€å“ã§ã•ã‚‰ã«æ•´ã†ã‹ã‚‚ï¼";
    return "ä»Šæ—¥ã¯ã¾ã ã“ã‚Œã‹ã‚‰ã€‚è»½ã1å“è¨˜éŒ²ã—ã¦ã¿ã‚ˆã†ï¼";
  }
  return tips[0];
}

/* ========== ã‚¯ã‚¨ã‚¹ãƒˆç”Ÿæˆï¼ˆä»Šæ—¥ï¼‰ ========== */
function makeQuests(){
  const quests = [];

  // ä¸è¶³ã‚’è£œã†ã‚¯ã‚¨ã‚¹ãƒˆï¼ˆæœ€å¤§3ä»¶ï¼‰
  const diff = [
    {key:"protein", label:"ãŸã‚“ã±ãè³ª", need: target.protein - today.protein, unit:"g", hint:"åµãƒ»é­šãƒ»é¶ãƒ»è±†é¡ãŒãŠã™ã™ã‚", goto:"meal"},
    {key:"fat",     label:"è„‚è³ª",       need: target.fat     - today.fat,     unit:"g", hint:"ãƒŠãƒƒãƒ„ãƒ»ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«ãªã©è‰¯è³ªãªè„‚ã‚’", goto:"meal"},
    {key:"carbs",   label:"ç‚­æ°´åŒ–ç‰©",   need: target.carbs   - today.carbs,   unit:"g", hint:"ã”ã¯ã‚“ãƒ»éººãƒ»ã„ã‚‚é¡ã§ã‚¨ãƒãƒ«ã‚®ãƒ¼è£œçµ¦", goto:"meal"},
  ].filter(x=>x.need>8).sort((a,b)=>b.need-a.need).slice(0,3)
   .forEach(x => quests.push({
      title:`${x.label}ã‚’è£œçµ¦ï¼ˆ${Math.round(x.need)}${x.unit}ï¼‰`,
      desc:x.hint,
      action:x.goto
   }));

  // æ±ç”¨ã‚¯ã‚¨ã‚¹ãƒˆ
  if(todayMeals.length === 0){
    quests.unshift({title:"ã¾ãšã¯1æšè¨˜éŒ²ã—ã‚ˆã†", desc:"å†™çœŸã‚’æ’®ã£ã¦ç™»éŒ²ï¼", action:"meal"});
  }else if(todayMeals.length < 3){
    quests.push({title:`ä»Šæ—¥ã¯ã‚ã¨ ${3-todayMeals.length} é£Ÿ è¨˜éŒ²`, desc:"ã“ã¾ã‚ã«è¨˜éŒ²ã—ã¦è‡ªå·±åˆ†æ", action:"meal"});
  }
  return quests;
}

/* ========== ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ ========== */
function getWeekDates(n=7){
  const out=[]; const now=new Date();
  for(let i=0;i<n;i++){ const d=new Date(now); d.setDate(now.getDate()-i); out.push(d.toISOString().slice(0,10)); }
  return out;
}
function makeChallenges(){
  // ç›´è¿‘7æ—¥ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯æ–™ç†æ•°
  const weekDates = new Set(getWeekDates());
  const names = new Set();
  let daysWithAny = 0;
  for(const m of meals){
    const d = (m.date||"").slice(0,10);
    if(weekDates.has(d)){ names.add(String(m.food||"ä¸æ˜")); }
  }
  // é€£ç¶šè¨˜éŒ²ï¼ˆä»Šæ—¥ã‹ã‚‰éå»ã¸ï¼‰
  let streak=0;
  for(const d of getWeekDates(7)){
    const has = meals.some(m => (m.date||"").slice(0,10)===d);
    if(has) streak++; else break;
  }
  const list = [
    { title:"ä»Šé€± æ–°ã—ã„æ–™ç†ã‚’ 5 ç¨® é›†ã‚ã‚‹", desc:`ç¾åœ¨ ${names.size} / 5 ç¨®`, done:names.size>=5, action:"dex" },
    { title:"3æ—¥é€£ç¶šã§è¨˜éŒ²", desc:`ç¾åœ¨ ${streak} æ—¥`, done:streak>=3, action:"meal" },
    { title:"ãƒãƒ©ãƒ³ã‚¹åº¦80ä»¥ä¸Šã‚’é”æˆ", desc:`ä»Šæ—¥ ${balance} / 80`, done:balance>=80, action:"insights" },
  ];
  return list;
}

/* ========== æç”» ========== */
document.getElementById("unlockedNum").textContent = unlockedChars;
document.getElementById("balanceScore").textContent = balance;
document.getElementById("titleBadge").textContent = "ç§°å·: " + calcTitle(unlockedChars, balance);
document.getElementById("gbar").style.width = balance + "%";
document.getElementById("bubble").textContent = talk();

// ãƒ‡ã‚¤ãƒªãƒ¼ã‚¯ã‚¨ã‚¹ãƒˆ
const qRoot = document.getElementById("questList");
makeQuests().forEach(q=>{
  const el = document.createElement("div");
  el.className="card";
  el.innerHTML = `
    <div class="head"><div class="label">ğŸ¯ ${q.title}</div></div>
    <div class="small">${q.desc}</div>
    <div class="cta">
      <button class="btn" data-goto="${q.action}">ã‚„ã£ã¦ã¿ã‚‹</button>
    </div>`;
  qRoot.appendChild(el);
});

// ãƒãƒ£ãƒ¬ãƒ³ã‚¸
const cRoot = document.getElementById("challengeList");
makeChallenges().forEach(c=>{
  const el = document.createElement("div");
  el.className="card";
  el.innerHTML = `
    <div class="head">
      <div class="label">${c.done ? "âœ…" : "ğŸ†"} ${c.title}</div>
      <div class="small ${c.done?'ok':'warn'}">${c.desc}</div>
    </div>
    <div class="cta">
      <button class="btn ${c.done?'secondary':''}" data-goto="${c.action}">
        ${c.done ? "ç¢ºèªã™ã‚‹" : "ç›®æŒ‡ã™"}
      </button>
    </div>`;
  cRoot.appendChild(el);
});

// ç”»é¢é·ç§»
function goMeal(){ location.href = "../meal/index.html"; }
function goInsights(){ location.href = "../insights/index.html"; }
function goDex(){ location.href = "../dex/index.html"; }
document.addEventListener("click", (e)=>{
  const b = e.target.closest("button[data-goto]");
  if(!b) return;
  const to = b.dataset.goto;
  if(to==="meal") goMeal();
  else if(to==="insights") goInsights();
  else if(to==="dex") goDex();
});

// ã‚­ãƒ£ãƒ©ç”»åƒï¼ˆé¸æŠä¿å­˜ã«å¯¾å¿œãƒ»ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
(function initChar(){
  const chosen = localStorage.getItem("bisyokuka_char_img"); // ä»»æ„: è¨­å®šç”»é¢ã§ä¿å­˜ã§ãã‚‹ã‚ˆã†ã«æƒ³å®š
  if(chosen){ document.getElementById("charImg").src = chosen; }
})();
</script>
</body>
</html>
