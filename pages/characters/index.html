<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚­ãƒ£ãƒ©è‚²æˆ</title>
  <link rel="stylesheet" href="style.css">
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --line:#1f2937;
      --accent:#f59e0b; --brand:#0ea5e9; --muted:#9ca3af;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Poppins,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .title{font-weight:800}
    .row{display:grid;grid-template-columns: 180px 1fr 220px; gap:12px}
    @media (max-width:860px){ .row{grid-template-columns: 1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .gauge{height:10px;background:#0b1220;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#34d399,#0ea5e9)}
    .badge{display:inline-block;background:#1f2937;border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px;color:#cbd5e1}

    /* ===== Spriteï¼ˆ1ã‚³ãƒåˆ‡ã‚Šå‡ºã— & ã‚¢ãƒ‹ãƒ¡ï¼‰ ===== */
    .stage{display:flex;align-items:center;justify-content:center;min-height:240px}
    .sprite{
      width:96px; height:128px;   /* ã‚·ãƒ¼ãƒˆå…¨ä½“ã‚µã‚¤ã‚ºï¼ˆ3Ã—4ï¼‰ */
      image-rendering: pixelated;
      background-repeat:no-repeat;
      /* 3åˆ—Ã—4è¡Œã®ã‚·ãƒ¼ãƒˆã‚’ç™¾åˆ†ç‡ã§æ‰±ã†ï¼ˆèƒŒæ™¯å…¨ä½“ã‚’ 300%Ã—400% ã«ã™ã‚‹ã¨1ã‚¿ã‚¤ãƒ«=å¹…ã®1/3, é«˜ã•ã®1/4ï¼‰ */
      background-size: 300% 400%;
      /* èƒŒæ™¯ä½ç½®ã¯JSã§ row/col ã«å¿œã˜ã¦å¤‰æ›´ */
    }

    .say{margin-top:8px;font-size:14px;color:#e5e7eb;background:#0b1220;border:1px solid var(--line);padding:8px 10px;border-radius:10px}

    .quests{display:grid;grid-template-columns: 1fr 1fr;gap:8px}
    @media (max-width:860px){ .quests{grid-template-columns: 1fr} }
    .q{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .q .text{font-size:14px}
    .q .btn{background:var(--brand);color:#031422;border:none;border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 class="title">ğŸ§‘â€ğŸ³ ã‚­ãƒ£ãƒ©è‚²æˆ</h1>
      <span class="badge" id="titleBadge">ç§°å·ï¼šãƒ“ã‚®ãƒŠãƒ¼</span>
    </header>

    <div class="row">
      <!-- å·¦ï¼šã‚²ãƒ¼ã‚¸ -->
      <section class="card">
        <div style="font-weight:700;margin-bottom:6px">æˆé•·ã‚²ãƒ¼ã‚¸</div>
        <div class="gauge"><div id="growBar" class="bar" style="width:20%"></div></div>
        <div style="font-size:12px;color:#9ca3af;margin-top:6px">ä»Šæ—¥ã®æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã§è‚²æˆãŒé€²ã¿ã¾ã™</div>
      </section>

      <!-- ä¸­å¤®ï¼šã‚­ãƒ£ãƒ© -->
      <section class="card">
        <div class="stage">
          <div id="sprite" class="sprite"></div>
        </div>
        <div id="speech" class="say">ä»Šæ—¥ã¯ã€ŒãŸã‚“ã±ãè³ª 50â€“120gã€ã«è¿‘ã¥ã‘ã‚‹ã¨è‚²æˆãŒé€²ã‚€ã‚ˆï¼</div>
      </section>

      <!-- å³ï¼šã‚¯ã‚¨ã‚¹ãƒˆ/ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã—ã§è¦‹åˆ‡ã‚‹ï¼‰ -->
      <section class="card">
        <div style="font-weight:700;margin-bottom:6px">ã‚¯ã‚¨ã‚¹ãƒˆ / ãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
        <div class="quests">
          <div class="q card">
            <div class="text">Påˆè¨ˆ 80g ä»¥ä¸Š</div>
            <button class="btn" data-quest="p80">æŒ‘æˆ¦</button>
          </div>
          <div class="q card">
            <div class="text">é‡èœ 2å“ ä»¥ä¸Š</div>
            <button class="btn" data-quest="veg2">æŒ‘æˆ¦</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ==== ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆè¨­å®šï¼ˆ3åˆ—Ã—4è¡Œ / 1ã‚¿ã‚¤ãƒ«=32Ã—32px, ã‚·ãƒ¼ãƒˆ=96Ã—128pxï¼‰ ====
    const SHEET = "project-root/ç”·_ã‚¹ãƒ¼ãƒ„1.png";  // å¥½ããªã‚­ãƒ£ãƒ©ã«å·®ã—æ›¿ãˆ
    const COLS = 3, ROWS = 4;
    // è¡Œã®æ„å‘³ï¼ˆã‚·ãƒ¼ãƒˆã«ã‚ˆã‚Šé•ã†å ´åˆã¯èª¿æ•´ã—ã¦OKï¼‰
    const ROW_RIGHT = 0, ROW_LEFT = 1, ROW_FRONT = 2, ROW_BACK = 3;
    const COL_CENTER = 1, COL_LEFT = 0, COL_RIGHT = 2;

    const sprite = document.getElementById("sprite");
    sprite.style.backgroundImage = `url('${SHEET}')`;

    // 1ã‚³ãƒã®èƒŒæ™¯ä½ç½®ï¼ˆç™¾åˆ†ç‡ï¼‰ã‚’è¨ˆç®—
    function setFrame(el, row, col){
      // èƒŒæ™¯ã‚µã‚¤ã‚ºã‚’ 300%Ã—400% ã«ã—ã¦ã„ã‚‹ã®ã§ã€å„ã‚³ãƒã®å·¦ä¸Šã¯ 0%, 50% ãªã©ã®å‰²åˆã«ãªã‚‹
      const x = (col / (COLS - 1)) * 100;     // 0, 50, 100
      const y = (row / (ROWS - 1)) * 100;     // 0, 33.3, 66.6, 100
      el.style.backgroundPosition = `${x}% ${y}%`;
    }

    // åˆæœŸã¯æ­£é¢ãƒ»ä¸­å¤®ã‚³ãƒï¼ˆã‚¢ã‚¤ãƒ‰ãƒ«ï¼‰
    setFrame(sprite, ROW_FRONT, COL_CENTER);

    // ãŸã¾ã« â€œæ¨ªã«ãƒãƒ§ã‚¤æ­©ãâ€ ã‚¢ãƒ‹ãƒ¡ï¼ˆå·¦å³1å¾€å¾©ï¼‰
    function sideShuffle(){
      // å·¦ã‹å³ã‚’ãƒ©ãƒ³ãƒ€ãƒ 
      const toLeft = Math.random() < 0.5;
      const row = toLeft ? ROW_LEFT : ROW_RIGHT;
      const seq = [COL_CENTER, toLeft ? COL_LEFT : COL_RIGHT, COL_CENTER]; // ï¾„ï¾ï½¯ â†’ æˆ»ã‚‹
      let i = 0;
      const tick = setInterval(()=>{
        setFrame(sprite, row, seq[i]);
        i++;
        if(i >= seq.length){
          clearInterval(tick);
          // æ­£é¢ã«æˆ»ã™
          setFrame(sprite, ROW_FRONT, COL_CENTER);
        }
      }, 120);
    }

    // 6ã€œ12ç§’ã«ä¸€å›ã ã‘ç™ºç«
    function scheduleShuffle(){
      const ms = 6000 + Math.random()*6000;
      setTimeout(()=>{
        sideShuffle();
        scheduleShuffle();
      }, ms);
    }
    scheduleShuffle();

    // ====== æˆé•·ã‚²ãƒ¼ã‚¸ & ç§°å·ï¼ˆãƒ€ãƒŸãƒ¼ä¾‹ï¼‰ ======
    const meals = JSON.parse(localStorage.getItem("bisyokuka_meals_v2")||"[]");
    const todayKey = new Date().toISOString().slice(0,10);
    const today = meals.filter(m=>m.date?.slice(0,10)===todayKey);
    const sumP = today.reduce((a,b)=>a + Number(b.totals?.protein||0), 0);
    const pRate = Math.max(0, Math.min(1, sumP / 120)); // 120gã§100%
    document.getElementById("growBar").style.width = (pRate*100).toFixed(0) + "%";
    if(sumP >= 80) document.getElementById("titleBadge").textContent = "ç§°å·ï¼šãŸã‚“ã±ããƒã‚¹ã‚¿ãƒ¼";
  </script>
</body>
</html>
