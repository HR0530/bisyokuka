<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>美食家さん｜キャラ育成</title>

  <!-- ★これを最初に（共通ルーター）-->
  <script src="/view-router.js"></script>

  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <header class="app-header">
    <h1>🍽️ 美食家さん｜キャラ育成</h1>

    <nav class="nav-buttons">
      <button class="ghost-btn" id="btnHome">🏠 ホーム</button>
      <button class="ghost-btn" id="btnDex">📚 図鑑</button>
    </nav>

    <div class="user-summary">
      <div class="title-badge" id="titleBadge">見習いフーディー</div>
      <div class="xp-wrap">
        <div class="xp-label">
          <span id="levelText">Lv.1</span>
          <span id="xpText">0 / 100 XP</span>
        </div>
        <div class="xp-bar"><div id="xpFill"></div></div>
      </div>
    </div>
  </header>

  <main class="layout">
    <section class="stage-card">
      <div class="stage-toolbar">
        <div class="stat"><strong>体力</strong> <span id="hpText">100</span></div>
        <div class="stat"><strong>満足度</strong> <span id="satisfactionText">50</span></div>
        <button class="ghost-btn" id="toggleRun">一時停止</button>
      </div>

      <div class="stage">
        <div class="grid-bg" aria-hidden="true"></div>

        <!-- ★ キャラ（正面の静止画のみ） -->
        <div id="character" class="char dir-front" title="主人公"></div>

        <!-- ★ 吹き出し（復活） -->
        <div class="speech" id="speech">今日のPFCバランス、いい感じ？</div>

        <div class="stage-fab">
          <button class="fab" id="fabDex"  title="図鑑へ">📚</button>
          <button class="fab" id="fabHome" title="ホームへ">🏠</button>
        </div>
      </div>

      <details class="howto" open>
        <summary>称号・経験値はこう上がる（原理）</summary>
        <ul>
          <li>📷 食事記録を投稿：+20 XP（写真つき +30）</li>
          <li>🎯 カロリー目標達成：+40 XP（連続ボーナスあり）</li>
          <li>🧪 研究クエスト：各XP付与</li>
          <li>🔥 連続ログイン：日数 × 5 XP（最大 +25）</li>
        </ul>
        <div id="nutritionBadge" style="margin-top:8px;color:#94a3b8;font-size:12px"></div>
      </details>
    </section>

    <aside class="side-card">
      <h2>クエスト</h2>
      <div class="quest-list" id="questList"></div>

      <h3 class="mt">今日の活動ログ</h3>
      <ul class="log" id="activityLog"></ul>
    </aside>
  </main>

  <footer class="app-footer">
    © Bishokuka-san
    <div class="footer-actions">
      <button class="blue"  id="goInsights">確認する</button>
      <button class="green" id="quickClear">達成！ログをクリア</button>
    </div>
  </footer>

  <script>
(function(){
  // --- 設定（このページは PC=index.html / SP=index.mobile.html）---
  const PC_FILE = "index.html";
  const SP_FILE = "index.mobile.html";

  // --- 手動固定（?view=sp / ?view=pc） ---
  const qs = new URLSearchParams(location.search);
  const force = (qs.get("view")||"").toLowerCase();
  if (force === "sp" || force === "pc") {
    try { localStorage.setItem("viewMode", force); } catch {}
    qs.delete("view");
    const u = new URL(location.href); u.search = qs.toString();
    history.replaceState(null, "", u.toString());
    console.log("[router] force set:", force);
  }

  const pref = (localStorage.getItem("viewMode")||"").toLowerCase();

  // --- モバイル判定（サイズ + 指タッチ） ---
  function wantSP(){
    const narrow = matchMedia("(max-width: 820px)").matches;
    const coarse = matchMedia("(pointer: coarse)").matches;
    return narrow && coarse;
  }

  const path = location.pathname;
  const onSP = path.endsWith("/"+SP_FILE);
  const onPC = path.endsWith("/"+PC_FILE) && !onSP;

  function swapTo(file){
    const u = new URL(location.href);
    if (u.pathname.endsWith("/"+file)) return;
    u.pathname = u.pathname.replace(/[^/]+$/, file);
    console.log("[router] redirect ->", file);
    location.replace(u.toString());
  }

  console.log("[router] path:", path, "pref:", pref, "onSP:", onSP, "onPC:", onPC);

  if (pref === "sp") { if (!onSP) swapTo(SP_FILE); return; }
  if (pref === "pc") { if (!onPC) swapTo(PC_FILE); return; }

  const sp = wantSP();
  console.log("[router] wantSP:", sp);

  if (sp && !onSP) swapTo(SP_FILE);
  if (!sp && !onPC) swapTo(PC_FILE);

  // 画面サイズの再判定（手動固定が無い時だけ）
  if (!pref) {
    let t;
    addEventListener("resize", () => {
      clearTimeout(t);
      t = setTimeout(() => {
        const w = wantSP();
        console.log("[router] resize -> wantSP:", w);
        if (w && !/index\.mobile\.html$/i.test(location.pathname)) swapTo(SP_FILE);
        if (!w && /index\.mobile\.html$/i.test(location.pathname)) swapTo(PC_FILE);
      }, 120);
    });
  }
})();
</script>

</body>
</html>
