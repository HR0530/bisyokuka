<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã‚­ãƒ£ãƒ©è‚²æˆ | ç¾é£Ÿå®¶ã•ã‚“</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --line:#1f2937;
    --brand:#0ea5e9; --accent:#f59e0b; --ok:#22c55e;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Poppins,system-ui,Segoe UI,Roboto,Arial}
  a{color:#ffbb54;text-decoration:none}

  .wrap{max-width:1100px;margin:0 auto;padding:14px}

  /* header */
  .topbar{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:10px}
  .btn{
    background:#1f2937;border:1px solid var(--line);color:#e5e7eb;
    padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700
  }
  .btn.primary{background:var(--brand);color:#031422;border:none}
  .btn.ghost{background:#0b1220}
  .title{font-size:20px;font-weight:800}

  /* gauge section */
  .gauge-card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:10px}
  .gauge-label{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .badge{background:#1f2937;border:1px solid var(--line);padding:4px 10px;border-radius:999px;color:#cbd5e1;font-size:12px}
  .gauge{height:12px;border-radius:999px;overflow:hidden;background:#0b1220;border:1px solid var(--line)}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#34d399,#0ea5e9)}

  /* main layout */
  .grid{display:grid;grid-template-columns: 1.2fr 1fr; gap:12px}
  @media (max-width:900px){ .grid{grid-template-columns: 1fr} }

  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}

  /* stage + sprite */
  .stage{
    height:320px; display:flex; align-items:center; justify-content:center;
    background:radial-gradient(ellipse at center, #0b1220 0%, #0b1220 60%, transparent 60%) center 76% / 60% 10% no-repeat;
  }
  .sprite{
    width:96px; height:128px;            /* 3Ã—4ã‚·ãƒ¼ãƒˆå…¨ä½“ã‚µã‚¤ã‚º */
    image-rendering: pixelated;
    background-repeat:no-repeat;
    background-size: 300% 400%;          /* åˆ—=3, è¡Œ=4 ã‚’ç™¾åˆ†ç‡ã§æ‰±ã† */
    /* èƒŒæ™¯ä½ç½®ã¯JSã§æ“ä½œï¼ˆcol% row%ï¼‰ */
    transition: transform .12s linear;
  }
  .say{margin-top:8px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#0b1220;color:#e5e7eb}

  /* quests */
  .quests{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:900px){ .quests{grid-template-columns:1fr 1fr} }
  @media (max-width:560px){ .quests{grid-template-columns:1fr} }
  .q{display:flex;align-items:center;justify-content:space-between;gap:10px;background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:10px}
  .q .name{font-size:14px}
  .q .mini{font-size:11px;color:var(--muted)}
  .q .act{display:flex;gap:6px}
  .q .act .btn{padding:6px 10px}

</style>
</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <div class="title">ğŸ§‘â€ğŸ³ ã‚­ãƒ£ãƒ©è‚²æˆ</div>
      <div>
        <a class="btn" href="dex.html">ğŸ“š å›³é‘‘</a>
        <a class="btn ghost" href="../../index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      </div>
    </div>

    <!-- Gauge -->
    <section class="gauge-card">
      <div class="gauge-label">
        <div style="font-weight:700">æˆé•·ã‚²ãƒ¼ã‚¸</div>
        <div id="titleBadge" class="badge">ç§°å·ï¼šãƒ“ã‚®ãƒŠãƒ¼</div>
      </div>
      <div class="gauge"><div id="growBar" class="bar"></div></div>
      <div style="margin-top:6px;font-size:12px;color:var(--muted)">ä»Šæ—¥ã®æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã«å¿œã˜ã¦æˆé•·ã—ã¾ã™</div>
    </section>

    <section class="grid">
      <!-- å·¦ï¼šã‚­ãƒ£ãƒ© -->
      <div class="card">
        <div class="stage">
          <div id="sprite" class="sprite"></div>
        </div>
        <div id="speech" class="say">ä»Šæ—¥ã¯ã€ŒãŸã‚“ã±ãè³ª 50â€“120gã€ã«è¿‘ã¥ã‘ã‚‹ã¨è‚²æˆãŒé€²ã‚€ã‚ˆï¼</div>
      </div>

      <!-- å³ï¼šã‚¯ã‚¨ã‚¹ãƒˆ/ãƒãƒ£ãƒ¬ãƒ³ã‚¸ -->
      <div class="card">
        <div style="font-weight:700;margin-bottom:6px">ã‚¯ã‚¨ã‚¹ãƒˆ & ãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
        <div class="quests">
          <div class="q">
            <div>
              <div class="name">ãŸã‚“ã±ãè³ªåˆè¨ˆ 80g ä»¥ä¸Š</div>
              <div class="mini">Pã‚’æ„è­˜ã—ãŸé£Ÿæã‚’å–ã‚Šå…¥ã‚Œã‚ˆã†</div>
            </div>
            <div class="act"><button class="btn primary">æŒ‘æˆ¦</button></div>
          </div>
          <div class="q">
            <div>
              <div class="name">è„‚è³ªã¯ 60g ä»¥ä¸‹</div>
              <div class="mini">æšã’ç‰©ã¯æ§ãˆã‚ã«</div>
            </div>
            <div class="act"><button class="btn primary">æŒ‘æˆ¦</button></div>
          </div>
          <div class="q">
            <div>
              <div class="name">ç‚­æ°´åŒ–ç‰©ã¯ 200â€“300g</div>
              <div class="mini">ä¸»é£Ÿã§ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’ç¢ºä¿</div>
            </div>
            <div class="act"><button class="btn primary">æŒ‘æˆ¦</button></div>
          </div>
          <div class="q">
            <div>
              <div class="name">é‡èœãƒ»æµ·è—» 2å“ä»¥ä¸Š</div>
              <div class="mini">å½©ã‚Šã‚’å¢—ã‚„ã™ã¨é”æˆã—ã‚„ã™ã„ã‚ˆ</div>
            </div>
            <div class="act"><button class="btn primary">æŒ‘æˆ¦</button></div>
          </div>
        </div>
      </div>
    </section>

  </div>

<script>
/* ===================== Sprite Control =====================

  å‰æï¼š3åˆ—Ã—4è¡Œã®ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆï¼ˆä¾‹ï¼š96Ã—128ï¼‰
  è¡Œã®æ„å‘³ï¼š
    0: å³å‘ã / 1: å·¦å‘ã / 2: æ­£é¢ / 3: èƒŒé¢
  åˆ—ã®æ„å‘³ï¼š
    0: å·¦è¶³ / 1: ç«‹ã¡ï¼ˆä¸­å¤®ï¼‰/ 2: å³è¶³
  æ­£é¢ã®3ã‚³ãƒï¼ˆ0,1,2ï¼‰ã‚’ã€Œæ­£è¦ã®æ­£é¢ã€ã¨ã—ã¦ã‚¢ã‚¤ãƒ‰ãƒ«ã«ä½¿ç”¨ã€‚
  æ•°ç§’ã«ä¸€å›ã€å·¦å³ã®è¡Œã§ã€Œä¸­å¤®â†’ç«¯â†’ä¸­å¤®ã€ã‚’1å¾€å¾©ã—ã¦ã™ãæ­£é¢ã«æˆ»ã™ã€‚

========================================================== */

const SHEET = "project-root/å¥³_ã‚¹ãƒ¼ãƒ„1.png"; // â˜…å¥½ããªã‚­ãƒ£ãƒ©ã«å·®ã—æ›¿ãˆå¯
const COLS = 3, ROWS = 4;
const ROW_RIGHT = 0, ROW_LEFT = 1, ROW_FRONT = 2, ROW_BACK = 3;
const COL_LEFT = 0, COL_CENTER = 1, COL_RIGHT = 2;

const sprite = document.getElementById('sprite');
sprite.style.backgroundImage = `url('${SHEET}')`;

/** èƒŒæ™¯ä½ç½®ï¼ˆ%ï¼‰ã«å¤‰æ›ã—ã¦1ã‚³ãƒã‚’è¡¨ç¤º */
function setFrame(row, col){
  const x = (col/(COLS-1))*100;   // 0,50,100
  const y = (row/(ROWS-1))*100;   // 0,33.33,66.66,100
  sprite.style.backgroundPosition = `${x}% ${y}%`;
}

/** æ­£é¢ã‚¢ã‚¤ãƒ‰ãƒ«ï¼ˆ3ã‚³ãƒã‚’ã®ã‚“ã³ã‚Šç‚¹æ»…ï¼‰ */
let idleTimer=null, step=0;
function startIdle(){
  stopIdle();
  idleTimer = setInterval(()=>{
    // æ­£é¢ï¼šå·¦å³â†’ä¸­å¤® ã§ã»ã‚“ã®å°‘ã—æºã‚‰ã™
    const seq = [COL_LEFT, COL_CENTER, COL_RIGHT, COL_CENTER];
    setFrame(ROW_FRONT, seq[step % seq.length]);
    step++;
  }, 400);
}
function stopIdle(){ if(idleTimer){ clearInterval(idleTimer); idleTimer=null; } }

/** ç‰‡å´ã«ä¸€æ­©ã ã‘ï¼ˆæ¨ªå‘ãâ†’ç«¯â†’ä¸­å¤®â†’æ­£é¢ï¼‰ */
function sideShuffle(){
  stopIdle();
  const toLeft = Math.random() < 0.5;
  const row = toLeft ? ROW_LEFT : ROW_RIGHT;
  const seq = [COL_CENTER, toLeft?COL_LEFT:COL_RIGHT, COL_CENTER];
  let i = 0;
  const walk = setInterval(()=>{
    setFrame(row, seq[i]);
    // ã¡ã‚‡ã£ã¨ã ã‘æ¨ªç§»å‹•ã—ã¦é›°å›²æ°—UP
    sprite.style.transform = `translateX(${toLeft?'-':'+'}${i===1?6:0}px)`;
    i++;
    if(i >= seq.length){
      clearInterval(walk);
      sprite.style.transform = 'translateX(0)';
      // æ­£é¢ã¸æˆ»ã—ã¦ã‚¢ã‚¤ãƒ‰ãƒ«å†é–‹
      setFrame(ROW_FRONT, COL_CENTER);
      startIdle();
    }
  }, 140);
}

/** ãƒ©ãƒ³ãƒ€ãƒ ã«ç™ºç«ï¼ˆ6ã€œ12ç§’æ¯ï¼‰ */
function scheduleShuffle(){
  setTimeout(()=>{
    sideShuffle();
    scheduleShuffle();
  }, 6000 + Math.random()*6000);
}

// åˆæœŸè¡¨ç¤ºï¼šæ­£é¢ä¸­å¤®â†’ã‚¢ã‚¤ãƒ‰ãƒ«é–‹å§‹
setFrame(ROW_FRONT, COL_CENTER);
startIdle();
scheduleShuffle();

/* ====== ã‚²ãƒ¼ã‚¸/ç§°å·ï¼ˆä»Šæ—¥ã®é£Ÿäº‹ã‹ã‚‰æ¦‚ç®—ï¼‰ ====== */
const meals = JSON.parse(localStorage.getItem("bisyokuka_meals_v2")||"[]");
const todayKey = new Date().toISOString().slice(0,10);
const today = meals.filter(m => (m.date||"").slice(0,10)===todayKey);
const sumP = today.reduce((a,b)=> a + Number(b.totals?.protein||0), 0);
const sumF = today.reduce((a,b)=> a + Number(b.totals?.fat||0), 0);
const sumC = today.reduce((a,b)=> a + Number(b.totals?.carbs||0), 0);

// ç›®å®‰ï¼šP120gã§MAX
const pRate = Math.max(0, Math.min(1, sumP/120));
document.getElementById('growBar').style.width = (pRate*100).toFixed(0)+'%';

const badge = document.getElementById('titleBadge');
if(sumP >= 120 && sumF <= 60) badge.textContent = 'ç§°å·ï¼šæ „é¤Šè³¢è€…';
else if(sumP >= 80) badge.textContent = 'ç§°å·ï¼šãŸã‚“ã±ããƒã‚¹ã‚¿ãƒ¼';

/* ã—ã‚ƒã¹ã‚‹å†…å®¹ã‚‚è»½ãæ›´æ–° */
const sp = document.getElementById('speech');
if(sumP < 50) sp.textContent = 'ä»Šæ—¥ã¯På°‘ãªã‚ã€‚é¶ã‚€ã­ãƒ»è±†è…ãƒ»åµã§åº•ä¸Šã’ã—ã‚ˆã†ï¼';
else if(sumF > 70) sp.textContent = 'è„‚è³ªãŒå¤šã‚ã€‚æšã’ç‰©ã‚’1å“ã‚«ãƒƒãƒˆã§â—';
else sp.textContent = 'ã„ã„ãƒãƒ©ãƒ³ã‚¹ï¼ãã®èª¿å­ã€œ';
</script>
</body>
</html>
